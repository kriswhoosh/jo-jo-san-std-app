<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>RATE MATE — GOLD v1.2</title>
  <style>
    :root{ --bg:#1a0b2e; --header:#2a0a44; --card:#22103a; --gold:#ffd400; --pink:#ff4d94; --text:#ffd400; }
    body{ margin:0; background:var(--bg); color:var(--text); font-family: sans-serif; text-align:center; }
    header{ background:var(--header); padding:15px; border-bottom:1px solid rgba(255,212,0,0.3); }
    .wrap{ padding:15px; max-width:500px; margin:auto; }
    .card{ background:var(--card); padding:20px; border-radius:15px; border:1px solid rgba(255,255,255,0.1); }
    label{ display:block; margin-top:10px; font-size:11px; text-transform:uppercase; color:var(--pink); letter-spacing:1px; }
    input, select{ width:100%; padding:10px; margin:8px 0; background:#150826; color:#ffd400; border:1px solid #ff4d94; border-radius:8px; text-align:center; font-size:16px; box-sizing: border-box; }
    .result{ font-size:42px; font-weight:bold; color:#ff4d94; margin:15px 0; }
    .btn-group{ display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top:15px; }
    .btn{ background:linear-gradient(135deg,#1ec86d,#118e49); color:white; padding:12px; border:none; border-radius:8px; cursor:pointer; font-weight:bold; text-transform:uppercase; font-size:12px; }
    .btn.whatsapp{ background: #25D366; color: #075E54; }
    .btn.email{ background: #ea4335; color: white; }
    .copy-msg{ font-size: 11px; color: #1ec86d; margin-top: 5px; height: 14px; }
  </style>
</head>
<body>
  <header><div>RATE MATE — GOLD</div></header>
  <div class="wrap">
    <div class="card">
      <label>Vehicle</label>
      <select id="vehicle" onchange="calculate()">
        <option value="SV">SV</option>
        <option value="SWB">SWB</option>
        <option value="LWB" selected>LWB</option>
        <option value="XLWB">XLWB</option>
        <option value="Luton">Luton</option>
        <option value="5t">5t</option>
        <option value="7.5t">7.5t</option>
        <option value="18t">18t</option>
        <option value="Artic">Artic</option>
        <option value="3M+">3M+ MEGA</option>
      </select>

      <label>Miles</label>
      <input id="miles" type="number" step="0.01" oninput="calculate()">

      <div class="result" id="finalPrice">£0</div>
      
      <div class="btn-group">
        <button class="btn whatsapp" onclick="copyQuote('whatsapp')">Copy WhatsApp</button>
        <button class="btn email" onclick="copyQuote('email')">Copy Email</button>
      </div>
      <div id="copyStatus" class="copy-msg"></div>
    </div>
  </div>

  <script>
    // At the very start of your script section
window.onload = () => {
    const params = new URLSearchParams(window.location.search);
    
    if (params.has('miles')) {
        // Fill the fields immediately from the URL
        document.getElementById('miles').value = params.get('miles');
        document.getElementById('vehicle').value = params.get('vehicle') || 'LWB';
        
        // Update the internal quote data for WhatsApp
        quoteData.pcA = params.get('pcA') || '';
        quoteData.pcB = params.get('pcB') || '';
        quoteData.viaText = params.get('viaText') || '';
        quoteData.waypointCount = parseInt(params.get('waypointCount')) || 0;
        quoteData.distTxt = params.get('miles') + ' miles';

        // Run the price calculation
        calculate();
    }
};

    const RATES = { "SV":1.10, "SWB":1.25, "LWB":1.35, "XLWB":1.50, "Luton":1.65, "5t":2.50, "7.5t":2.89, "18t":3.85, "Artic":4.85, "3M+":6.00 };
    const MINS = { "SV":50, "SWB":59, "LWB":69, "XLWB":79, "Luton":99, "5t":199, "7.5t":229, "18t":269, "Artic":289, "3M+":299 };
    const TARIFFS = {
      "SV":[20,15,12.5,10], "SWB":[22.5,17,14,11.5], "LWB":[24.5,18.5,15.5,12.5], "XLWB":[27.5,20.5,17,13.5], 
      "Luton":[30,22.5,18.5,15], "5t":[45.5,34,28.5,22.5], "7.5t":[52.5,39.5,33,26.5], "18t":[70,52.5,44,35], 
      "Artic":[88,66,55,44], "3M+":[109,82,68,54.5]
    };

    // Update your quoteData object at the top of the script
let quoteData = { pcA: '', pcB: '', distTxt: '', price: 0, waypointCount: 0, viaText: '' };

window.addEventListener('message', (e) => {
  if (e.data.type === 'rate-mate') {
    // ... existing lines ...
    quoteData.viaText = e.data.viaText || ''; // New line to capture postcodes
    calculate();
  }
});

    function calculate() {
      const v = document.getElementById('vehicle').value;
      const m = parseFloat(document.getElementById('miles').value) || 0;
      const stops = quoteData.waypointCount || 0;

      // 1. Waypoint Fee Tiers
      let stopFee = 15;
      if (v === "5t" || v === "7.5t") stopFee = 25;function extractLocations(text){
    const s = String(text || '');
    // Regex to find "From", "To", and "Via" (with support for multiple 'vias' separated by 'and' or commas)
    const m = s.match(/from\s+([\s\S]+?)\s+to\s+([\s\S]+?)(?:\s+via\s+([\s\S]+))?$/i);
    
    if(m){
      const A = m[1].trim();
      const B = m[2].trim();
      const vias = [];
      if(m[3]){ 
        // Splits "Oxford and Reading" or "Oxford, Reading" into individual points
        vias.push(...m[3].split(/,|and|via/i).map(x => x.trim()).filter(Boolean)); 
      }
      return [A, ...vias, B];
    }

    // Fallback: If no "From/To" pattern is found, look for postcodes
    const pcs = extractPostcodes(s);
    if(pcs && pcs.length >= 2) return pcs;
    
    return [];
  }
      else if (v === "18t" || v === "Artic" || v === "3M+") stopFee = 40;

      // 2. Mileage Tariffs
      let t = 0;
      if (m >= 20 && m < 40) t = TARIFFS[v][0];
      else if (m >= 40 && m < 60) t = TARIFFS[v][1];
      else if (m >= 60 && m < 80) t = TARIFFS[v][2];
      else if (m >= 80 && m < 100) t = TARIFFS[v][3];

      // 3. Calculation Logic
      const raw = (m * RATES[v]) + t + (stops * stopFee);
      const final = Math.round(Math.max(MINS[v], raw));
      
      document.getElementById('finalPrice').textContent = '£' + final;
      quoteData.price = final;
    }

    function copyQuote(type) {
  const v = document.getElementById('vehicle').value;
  const isWA = type === 'whatsapp';
  const b = isWA ? '*' : ''; 
  
  // Format the waypoint section: (inc. 2 stop[s] (B71 4EX, B69 2HG))
  let stopDetails = '';
  if (quoteData.waypointCount > 0) {
    const pcods = quoteData.viaText ? ` (${quoteData.viaText})` : '';
    stopDetails = ` (inc. ${quoteData.waypointCount} stop[s]${pcods})`;
  }
  
  const text = `Thank you for your enquiry\n\n` +
               `We would like to offer the following\n\n` +
               `From ${b}${quoteData.pcA}${b} to ${b}${quoteData.pcB}${b} (${quoteData.distTxt})${stopDetails}\n` +
               `Based on ${b}${v}${b} (min)\n` +
               `Price = ${b}£${quoteData.price}${b} + vat\n\n` +
               `⭐ Please let me know ⭐`;

  navigator.clipboard.writeText(text).then(() => {
    const status = document.getElementById('copyStatus');
    status.textContent = 'Quote copied to clipboard!';
    setTimeout(() => status.textContent = '', 2000);
  });
}

    window.addEventListener('message', (e) => {
      if (e.data.type === 'rate-mate') {
        console.log("RATE-MATE received data:", e.data);

        // 1. Force the Mileage update
        if (e.data.miles) {
            const milesInput = document.getElementById('miles');
            milesInput.value = e.data.miles;
        }

        // 2. Force the Vehicle update
        if (e.data.vehicle && RATES[e.data.vehicle]) {
            document.getElementById('vehicle').value = e.data.vehicle;
        }
        
        // 3. Sync all other quote data
        quoteData.pcA = e.data.pcA || '';
        quoteData.pcB = e.data.pcB || '';
        quoteData.distTxt = e.data.distTxt || '';
        quoteData.waypointCount = e.data.waypointCount || 0;
        quoteData.viaText = e.data.viaText || '';
        
        // 4. Run the calculation immediately
        calculate();
      }
    });
  </script>
</body>
</html>