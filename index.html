<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>JO-JO-SAN</title>
<link rel="icon" type="image/png" href="jo-jo-san.png">
<style>
  :root{ --bg:#1a0033; --card:#2a0a4a; --muted:#c59fd6; --ink:#f7f7f7; --line:#3a2358; --accent:#22c55e; --pill:#1f2937; --chip:#0e1520; --brand:#ffd94a; --pink:#ff7ab6; --bad:#ef4444; }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:#f7f7f7;font-family:Inter,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
  header{margin-bottom:14px;background:#2a0a4a;border:1px solid rgba(255,255,255,0.06);border-radius:14px;padding:16px;text-align:center}
  h1{margin:0;font-size:34px;font-weight:900;color:#ffd94a}
  .card{background:#151c24;border:1px solid #233141;border-radius:14px;padding:14px;margin:12px 0;color:#ff7ab6;text-align:center}
  .card h3{color:#ffd94a;margin:0 0 8px}
  .row2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media (max-width:900px){.row2{grid-template-columns:1fr}}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px;text-align:left}
  input[type=text],textarea{width:100%;background:#0e1520;color:#e6eefc;border:1px solid #233141;border-radius:10px;padding:10px 12px;font-size:14px;outline:0;text-align:left}
  textarea{min-height:140px;resize:vertical}
  button{padding:10px 14px;border:0;border-radius:10px;font-weight:700;cursor:pointer;color:#ffd94a}
  .btn{background:#1f2937;color:#ffd94a;border:1px solid #233141}.success{background:#22c55e;color:#06260e}.danger{background:#ef4444;color:#fff2c1}.swap{background:#374151;color:#ffd94a}
  .stat{background:#0e1520;border:1px solid #233141;border-radius:10px;padding:10px;margin:8px 0}
  .chips{display:flex;flex-wrap:wrap;gap:6px;align-items:center;justify-content:center}
  .chip{background:#0e1520;border:1px solid #233141;border-radius:999px;padding:6px 10px;font-size:12px;user-select:none;color:inherit}
  .chip.a{outline:2px solid #86efac}.chip.b{outline:2px solid #93c5fd}
  .arrow{opacity:.6;margin:0 4px}
  .valmsg{font-size:11px;color:#ef9a9a;margin-top:4px;text-align:left}
  .code-box{background:#0e1520;border:1px solid #233141;border-radius:10px;padding:12px;margin:12px 0;font-family:monospace;font-size:12px;color:#93c5fd;overflow-x:auto}
  /* Ensure the button classes use your theme variables */
  .blue {
      background-color: #2563eb !important; /* Standard Blue */
      color: var(--brand) !important;
  }

  .purple {
      background: #6d28d9 !important; /* Standard Purple */
      color: var(--brand) !important;
  }

  /* Ensure buttons have a consistent base style */
  button {
      padding: 10px 14px;
      border: 0;
      border-radius: 10px;
      font-weight: 700;
      cursor: pointer;
      transition: opacity 0.2s;
  }
  button:hover {
      opacity: 0.9;
  }
</style>
</head>
<body>
<div class="wrap">
  <header><h1><strong>JO-JO-SAN</strong></h1><div style="color:#ff7ab6;font-weight:700;margin-top:4px">Another Kriswhoosh Project</div></header>

  <div class="card"><div class="chips" id="routeChips"><span class="hint">↓ Try parsing a route below ↓</span></div></div>

  <div class="row2">
    <div class="card">
      <h3>Copy & Paste TEXT area</h3>
      <textarea id="snippet" placeholder="Examples: BL5 1EE to B77 5PN"></textarea>
      <div class="actions" style="margin-top:10px;">
        <button class="success" id="btnParse">Parse Text</button>
      </div>
    </div>
  </div>

  <div class="card" id="manualCard">
    <h3>Manual Fields</h3>
    <div class="row">
      <div><label><small>From (A)</small></label><input id="pcA" type="text"></div>
      <div><label><small>To (B)</small></label><input id="pcB" type="text"></div>
    </div>
    <div style="margin-top:8px">
      <label><small>Waypoints (Via) - Separate with commas</small></label>
      <input id="pcVia" type="text" placeholder="e.g., Leeds, Manchester">
    </div>
    
    <div style="margin-top:12px">
      <label><small>Select Vehicle for RATE-MATE</small></label>
      <div class="chips" id="vehicleSelectors" style="margin-top:8px; justify-content: flex-start;">
        </div>
      <input type="hidden" id="suggestedVehicle" value="LWB">
    </div>
    
    <div style="margin-top:10px" class="actions">
      <button class="blue" id="btnCalc">Calculate Route</button>
      <button class="purple" id="btnRateMate" style="display:none">Let's RATE-MATE it</button>
      <button class="swap" id="btnSwap">Swap A ↔ B</button>
      <button class="danger" id="btnClear">Clear</button>
    </div>
  </div>

  <div class="card">
    <h3>Results</h3>
    <div id="status" class="hint">Waiting for input…</div>
    <div class="stat">Route: <span id="routeAB"></span></div>
    <div class="stat">Distance: <span id="distance"></span></div>
    <div class="stat">Drive Time: <span id="duration"></span></div>
  </div>

  <div class="card" id="rateMateCard" style="display:none;background:#1a0033;border:2px solid #6d28d9">
    <h3 style="color:#ff4d9f">RATE-MATE</h3>
    <iframe id="rateMateFrame" style="width:100%;height:650px;border:none;border-radius:10px"></iframe>
  </div>

  <details class="card"><summary>Debug</summary><pre id="debug">Ready.</pre></details>
</div>

<script src="rate-mate-bridge.js"></script>
<script>
(function(){
  'use strict';
  const $ = id => document.getElementById(id);
  const log = msg => { const d=$('debug'); d.textContent+='\n'+msg; d.scrollTop=d.scrollHeight; };
  
  function extractLocations(text){
    const s = String(text || '');
    // Regex to find "From", "To", and "Via" (with support for multiple 'vias' separated by 'and' or commas)
    const m = s.match(/from\s+([\s\S]+?)\s+to\s+([\s\S]+?)(?:\s+via\s+([\s\S]+))?$/i);
    
    if(m){
      const A = m[1].trim();
      const B = m[2].trim();
      const vias = [];
      if(m[3]){ 
        // Splits "Oxford and Reading" or "Oxford, Reading" into individual points
        vias.push(...m[3].split(/,|and|via/i).map(x => x.trim()).filter(Boolean)); 
      }
      return [A, ...vias, B];
    }

    // Fallback: If no "From/To" pattern is found, look for postcodes
    const pcs = extractPostcodes(s);
    if(pcs && pcs.length >= 2) return pcs;
    
    return [];
  }

  $('btnParse').onclick = () => {
    const locs = extractLocations($('snippet').value);
    if(locs.length >= 2) { $('pcA').value = locs[0]; $('pcB').value = locs[1]; }
  };

  $('btnCalc').onclick = async () => {
    const from = $('pcA').value.trim();
    const to = $('pcB').value.trim();
    const viaRaw = $('pcVia').value.trim();
    
    if(!from || !to) return;
    
    // Create an array of all locations: [From, ...Vias, To]
    const viaPoints = viaRaw ? viaRaw.split(',').map(p => p.trim()).filter(p => p) : [];
    const allLocations = [from, ...viaPoints, to];
    
    $('status').textContent = 'Geocoding locations...';
    
    try {
        const geoPoints = [];
        for (const loc of allLocations) {
            const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(loc)}`).then(r => r.json());
            if (res.length > 0) {
                geoPoints.push({ lat: res[0].lat, lon: res[0].lon, name: res[0].display_name.split(',')[0] });
            }
        }

        // Build OSRM Coordinate String: lon,lat;lon,lat;...
        const coordString = geoPoints.map(g => `${g.lon},${g.lat}`).join(';');
        const route = await fetch(`https://router.project-osrm.org/route/v1/driving/${coordString}?overview=false`).then(r => r.json());
        
        if (route.code !== 'Ok') throw new Error('Routing failed');

        const distMiles = (route.routes[0].distance / 1609.344).toFixed(2);
        $('routeAB').textContent = geoPoints.map(g => g.name).join(' → ');
        $('distance').textContent = distMiles + ' miles';
        
        // Save waypoint count for the bridge (excluding Start and End)
        window.currentWaypointCount = viaPoints.length;
        
        $('status').textContent = 'Route ready with ' + window.currentWaypointCount + ' stop(s).';
        RateMate.showButton();
    } catch(e) { 
        $('status').textContent = 'Error: ' + e.message; 
    }
};

  $('btnClear').onclick = () => { window.location.reload(); };
  
  window.selectVeh = function(btn, val) {
    // Reset all chips in this section to their base style
    const allChips = document.querySelectorAll('#vehicleSelectors .chip');
    allChips.forEach(c => {
        c.style.outline = 'none';
        c.style.background = 'var(--chip)';
        c.style.color = 'inherit';
    });

    // Highlight the one you just clicked
    btn.style.outline = '2px solid var(--brand)';
    btn.style.background = 'var(--pill)';
    
    // Update the hidden value that goes to RATE-MATE bridge
    const hiddenInput = document.getElementById('suggestedVehicle');
    if (hiddenInput) {
        hiddenInput.value = val;
    }
  };

  // Ensure LWB is selected when the page first opens
  window.addEventListener('DOMContentLoaded', () => {
    const defaultBtn = document.getElementById('defaultVeh');
    if (defaultBtn) {
        selectVeh(defaultBtn, 'LWB');
    }
  });

})(); // This closes the (function(){ block started at the top
</script>
</body>
</html>